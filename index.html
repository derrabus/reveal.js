<!doctype html>  
<html lang="en">
	
	<head>
		<meta charset="utf-8">
		
		<title>The Dark Side of Traits</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Alexander M. Turek">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		
		<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
		
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/derrabus.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>
	
	<body>
		
		<div class="reveal">

			<!-- Used to fade in a background when a specific slide state is reached -->
			<div class="state-background"></div>
			
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>The Dark Side<br/>of Traits</h1>
					<h3>Dipl.-Inform. Alexander M. Turek</h3>
				</section>
                <section>
                    <h2>about me</h2>
                    <h3>Alexander M. Turek</h3>
                    <p>software developer</p>
                    <p>freelancer</p>
                    <p>php enthusiast</p>
                    <p>based in Munich, Germany</p>
                </section>
                <section>
                    <h2>outline</h2>
                    <p>object-oriented code reuse</p>
                    <p>anatomy of a trait</p>
                    <p>use-cases for traits</p>
                    <p>the dark side of traits</p>
                </section>
                <section>
                    <h2>poor man's code reuse</h2>
                    <section>
                        <h3>level 1</h3>
                        <p><em>&quot;All my classes need to handle errors.&quot;</em></p>
                        <p><em>&quot;I don't want to copy&amp;paste my error handling code.&quot;</em></p>
                        <p><em>&quot;Let's build an abstract class for that!&quot;</em></p>
                    </section>
                    <section>
                        <h3>level 1</h3>
                        <pre><code>abstract class MyError {
    protected function handleError($message) {
        throw new MyException($message);
    }
}

class SomeClass extends MyError {
    &#133;
}</code></pre>
                    </section>
                    <section>
                        <h3>level 2</h3>
                        <p><em>&quot;My classes <u>might</u> need to log stuff.&quot;</em></p>
                        <p><em>&quot;But I only have single inheritance&#133;&quot;</em></p>
                    </section>
                    <section>
                        <h3>level 2</h3>
                        <pre><code>abstract class MyObject {
    protected function handleError($message) { &#133; }
    protected function log($level, $message) { &#133; }

    &#133;
}

class SomeClass extends MyObject {
    &#133;
}</code></pre>
                    </section>
                    <section>
                        <h3>level 3</h3>
                        <pre><code>abstract class MyAdamClass {
    protected function handleError($message) { &#133; }
    protected function log($level, $message) { &#133; }
    protected function sort($array) { &#133; }
    protected function queryDb($sql) { &#133; }
    protected function sendMail($to, $subject, $message) { &#133; }
    protected function makeCoffee($type) { &#133; }
    protected function orderPizza($toppings, $size) { &#133; }

    &#133;
}

class SomeClass extends MyError {
    &#133;
}</code></pre>
                    </section>
                    <section>
                        <h3>guess what?</h3>
                        <p>inheritance is not a mechanism of code reuse</p>
                        <p>this is not breaking news, is it?</p>
                    </section>
                </section>
                <section>
                    <h2>class composition</h2>
                    <section>
                        <h3>favor composition over inheritance</h3>
                        <img src="img/logger-composition.svg"/>
                    </section>
                    <section>
                        <h3>pros</h3>
                        <p>avoid tight coupling</p>
                        <p>separation of concerns</p>
                        <p>dependencies may be replaced</p>
                        <p>improve testability</p>
                    </section>
                    <section>
                        <h3>but&#133;</h3>
                        <pre><code>class SomeClass {
    private $logger;

    public function setLogger(Logger $logger) {
        $this->logger = $logger;
    }

    private function log($level, $message) {
        if (!is_null($this->logger)) {
            $this->logger->log($level, $message);
        }
    }

    &#133;
}</code></pre>
                    </section>
                    <section>
                        <h3>glue code pollution</h3>
                        <p>classes need to handle their dependencies</p>
                        <p>copy&amp;paste boilerplate code</p>
                        <p>very low complexity though</p>
                    </section>
                    <section>
                        <h3>real world boilerplate code</h3>
                        <img src="img/zend-eventmanager.png"/>
                        <p>
                            <small>
                                source:
                                <a href="http://framework.zend.com/manual/2.0/en/modules/zend.event-manager.event-manager.html">http://framework.zend.com/manual/2.0/en/modules/zend.event-manager.event-manager.html</a>
                            </small>
                        </p>
                    </section>
                    <section>
                        <h3>what's missing?</h3>
                        <p>there is no way to express composition on language level</p>
                        <p>once again: inheritance is not the answer</p>
                        <p><small>PS: introducing multiple inheritance isn't either</small></p>
                    </section>
                </section>
                <section>
                    <h2>traits to the rescue</h2>
                    <section>
                        <h3>small reusable code snippets</h3>
                        <pre><code>trait SomeTrait {
    public $someField;

    public function someMethod() {
        &#133;
    }
}</code></pre>
                        <pre><code>class SomeClass {
    use SomeTrait;

    &#133;
}</code></pre>
                        <p><em>&quot;compiler-assisted copy&amp;paste&quot;</em></p>
                    </section>
                    <section>
                        <h3>building blocks for classes</h3>
                        <blockquote cite="http://springerlink.metapress.com/content/169mbraepn4gmyd2/">
                            [&#133;] Our model is based on lightweight entities called traits, which serve as the basic
                            building blocks for classes and the primitive units of code reuse. Thus, traits satisfy the
                            needs for structure, modularization and reusability within a class.
                        </blockquote>
                        <p><small>
                            Nathanael Schärli, Stéphane Ducasse, Oscar Nierstrasz, Andrew P. Black. Traits: Composable Units
                            of Behaviour. Proceedings of the European Conference on Object-Oriented Programming (ECOOP).
                            Lecture Notes in Computer Science, Volume 2743, Springer-Verlag, 2003, pp. 248-274
                        </small></p>
                    </section>
                    <section>
                        <h3>summary: why traits?</h3>
                        <p>large classes can be decomposed into traits</p>
                        <p>common boilerplates can be moved into traits</p>
                        <p>traits can be shared across classes</p>
                        <p>horizontal code reuse</p>
                    </section>
                </section>
                <section>
                    <h2>anatomy of a trait</h2>
                    <section>
                        <h3>the logger example</h3>
                        <pre><code>trait LogTrait {
    private function log($level, $message) {
        &#133;
    }
}

class SomeClass {
    use LogTrait;

    &#133;
}</code></pre>
                    </section>
                    <section>
                        <h3>abstract methods</h3>
                        <p>traits may define abstract methods to indicate requirements</p>
                        <pre><code>trait SayHello {
    public function say() {
        echo 'Hello ' . $this->getName() . '!' . "\n";
    }

    abstract protected function getName();
}</code></pre>
                    </section>
                    <section>
                        <h3>composite traits</h3>
                        <p>you can use traits inside traits</p>
                        <pre><code>trait FooBar {
    use Foo, Bar;
}</code></pre>
                    </section>
                    <section>
                        <h3>aliasing</h3>
                        <p>make trait members available under a different name</p>
                        <pre><code>class SomeClass {
    use SayHello {
        SayHello::say as private yell;
    }
}</code></pre>
                    </section>
                    <section>
                        <h3>conflict resolution</h3>
                        <p>we might run into naming conflicts with two or more traits</p>
                        <pre><code>class SomeClass {
    use SayHello, SayGoodbye {
        SayHello::say insteadof SayGoodbye;
        SayGoodbye::say as bye;
    }
}</code></pre>
                        <p>note: classes may still override trait members</p>
                    </section>
                </section>
                <section>
                    <h2>the singleton trait</h2>
                    <section>
                        <h3>without traits</h3>
                        <pre><code>class SomeClass {
    private static $instance;

    public static function getInstance() {
        if (!isset(self::$instance)) {
            self::$instance = new SomeClass;
        }
        return self::$instance;
    }
}</code></pre>
                    </section>
                    <section>
                        <h3>with traits</h3>
                        <pre><code>trait Singleton {
    private static $instance;

    public static function getInstance() {
        if (!isset(self::$instance)) {
            self::$instance = new self;
        }
        return self::$instance;
    }
}

class SomeClass {
    use Singleton;
}</code></pre>
                    </section>
                    <section>
                        <h3>disclaimer</h3>
                        <p>I don't want to promote Singleton as a good pattern.</p>
                    </section>
                </section>
                <section>
                    <h2>the observer trait</h2>
                    <section>
                        <h3>observer pattern</h3>
                        <img src="img/wikipedia-observer.svg"/>
                        <p>
                            <small>
                                source:
                                <a href="http://en.wikipedia.org/wiki/Observer_pattern">http://en.wikipedia.org/wiki/Observer_pattern</a>
                            </small>
                        </p>
                    </section>
                    <section>
                        <h3>interfaces</h3>
                        <pre><code>interface Observer {
    public function notify();
}

interface Subject {
    public function registerObserver(Observer $observer);
    public function unregisterObserver(Observer $observer);
    public function notifyObservers();
}</code></pre>
                    </section>
                    <section>
                        <h3>the trait pt. I</h3>
                        <pre><code>trait SubjectTrait {
    private $observers = array();

    public function registerObserver(Observer $observer) {
        if (!in_array($observer, $this->observers, true)) {
            $this->observers[] = $observer;
        }
    }</code></pre>
                    </section>
                    <section>
                        <h3>the trait pt. II</h3>
<pre><code>    public function unregisterObserver(Observer $observer) {
        foreach ($this->observers as $key => $current) {
            if ($current === $observer) {
                unset($this->observers[$key]);
            }
        }
    }

    public function notifyObservers() {
        foreach ($this->observers as $current) {
            $current->notify();
        }
    }
}</code></pre>
                    </section>
                    <section>
                        <h3>usage</h3>
                        <pre><code>class SomeClass implements Subject {
    use SubjectTrait;
}</code></pre>
                        <p>the trait serves as a default implementation for an interface</p>
                    </section>
                </section>
                <section>
                    <h2>so&#133;</h2>
                    <h3>&#133; traits are awesome?</h3>
                </section>
                <section>
                    <h2>php 5.4</h2>
                    <section>
                        <h3>still the new kid</h3>
                        <img src="img/php-versions.png"/>
                        <p>
                            <small>
                                source:
                                <a href="http://w3techs.com/technologies/details/pl-php/5/all">http://w3techs.com/technologies/details/pl-php/5/all</a>
                            </small>
                        </p>
                    </section>
                    <section>
                        <h3>popular linux server distributions</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Distribution</th>
                                    <th>php packages</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Ubuntu 12.04.1 LTS</td>
                                    <td>5.3.10</td>
                                </tr>
                                <tr>
                                    <td>Debian 6.0.6</td>
                                    <td>5.3.3</td>
                                </tr>
                                <tr>
                                    <td>SuSE Linux Enterprise Edition 11 SP2</td>
                                    <td>5.2.14/5.3.8</td>
                                </tr>
                                <tr>
                                    <td>openSUSE 12.2</td>
                                    <td>5.3.15</td>
                                </tr>
                                <tr>
                                    <td>RedHat Enterprise Linux 6.3</td>
                                    <td>5.3.x</td>
                                </tr>
                                <tr>
                                    <td>fedora 17</td>
                                    <td><strong>5.4.7</strong></td>
                                </tr>
                                <tr>
                                    <td>Gentoo Linux</td>
                                    <td>5.3.15/<strong>5.4.6</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </section>
                    <section>
                        <h3>the problem</h3>
                        <p>traits were introduced with php 5.4</p>
                        <p>using traits means depending on php 5.4</p>
                        <p>there is still little support for php 5.4</p>
                        <p>don't depend on php 5.4 just to get traits</p>
                    </section>
                </section>
                <section>
                    <h2>private access</h2>
                    <section>
                        <h3>back in the good ol' days&#133;</h3>
                        <p class="fragment">&#133; private members were accessible within their own class only</p>
                        <p class="fragment">well, breaking news: these days are gone</p>
                    </section>
                    <section>
                        <h3>even worse</h3>
                        <p>private methods may now define an interface</p>
                        <div class="fragment">
                            <p>communication between two traits</p>
                            <p>communication between a trait and its host class</p>
                        </div>
                    </section>
                    <section>
                        <h3>what's wrong here?</h3>
                        <pre><code>trait SayHello {
    private function what() {
        return 'Hello';
    }

    public function say() {
        echo $this->what();
    }
}

class SomeClass {
    use SayHello;

    private function what() {
        return 'Bye';
    }
}</code></pre>
                    </section>
                    <section>
                        <h3>no encapsulation</h3>
                        <p>a trait might use private methods for internal behavior</p>
                        <p>you might accidentally override those methods</p>
                        <p>this will silently break your trait</p>
                        <p>no error, no warning, no notice</p>
                    </section>
                    <section>
                        <h3>traits will touch your privates</h3>
                        <p>readability fail</p>
                        <p>changeability fail</p>
                        <p>testability fail</p>
                    </section>
                </section>
                <section>
                    <h2>testability</h2>
                    <section>
                        <h3>say hello to tight coupling again</h3>
                        <p>testability issues with abstract classes apply here, too</p>
                    </section>
                    <section>
                        <h3>proxy classes required</h3>
                        <p>traits cannot be tested directly, so we always need a proxy class</p>
                        <p>PHPUnit provides a <code>getObjectForTrait()</code> method</p>
                        <p><small>&#133; but it fails on traits with abstract members</small></p>
                    </section>
                    <section>
                        <h3>test isolation</h3>
                        <p>a trait is a hard-wired dependency</p>
                        <pre><code>class SomeClass {
    use SomeTrait;

    &#133;
}</code></pre>
                        <p>classes cannot be tested without testing the trait</p>
                        <p>trait cannot be replaced by a dummy</p>
                    </section>
                    <section>
                        <h3>summary</h3>
                        <p>your overall testability will suffer from traits</p>
                    </section>
                </section>
                <section>
                    <h2>recommendations</h2>
                    <h3>disclaimer</h3>
                    <p>these are my personal recommendations</p>
                    <p>use at your own risk</p>
                </section>
                <section>
                    <h2>the logger revisited</h2>
                    <pre><code>interface LoggerDependency {
    public function setLogger(Logger $logger);
}

trait LoggerProvider {
    private $logger;

    public function setLogger(Logger $logger) {
        $this->logger = $logger;
    }

    private function log($level, $message) {
        if (!is_null($this->logger)) {
            $this->logger->log($level, $message);
        }
    }
}</code></pre>
                </section>
                <section>
                    <h2>I</h2>
                    <h3>keep your traits stupid</h3>
                    <div class="fragment">
                        <p>use for boilerplates</p>
                        <p>use for glue code</p>
                        <p>don't use for real functionality</p>
                    </div>
                </section>
                <section>
                    <h2>II</h2>
                    <h3>favor class composition</h3>
                    <div class="fragment">
                        <p>class composition mitigates coupling, traits don't</p>
                        <p>however, traits may support class composition by encapsulating glue code</p>
                    </div>
                </section>
                <section>
                    <h2>III</h2>
                    <h3>do not depend on traits</h3>
                    <section>
                        <div class="fragment">
                            <p>yes, you can check at runtime if a trait is used&#133;</p>
                            <p>&#133; but ask yourself, if you really want to do this</p>
                            <p>you cannot type-hint traits &mdash; for a reason</p>
                        </div>
                    </section>
                    <section>
                        <p>DON'T DO THIS</p>
                        <pre><code>function foo($o) {
    if (!in_array('MyTrait', class_uses($o))) {
        throw new InvalidArgumentException;
    }
}</code></pre>
                        <p>DON'T DO THIS</p>
                    </section>
                    <section>
                        <p>GoF: <em>program to an interface, not an implementation</em></p>
                        <p>a trait <strong>is</strong> an implementation block</p>
                        <p>however, you can use a trait to fulfill an interface</p>
                    </section>
                </section>
                <section>
                    <h2>IV</h2>
                    <h3>team up with interfaces</h3>
                    <p>a trait should not define a public interface</p>
                    <p>if your trait adds functionality by extending the public interface of classes&#133;</p>
                    <p>&#133; use an <code>interface</code> to indicate this</p>
                </section>
                <section>
                    <h2>V</h2>
                    <h3>beware of the dark side</h3>
                    <div class="fragment">
                        <p>know what you're doing</p>
                        <p>don't just use traits because they're new and fancy</p>
                        <p>add traits to your coding guidelines</p>
                    </div>
                </section>
                <section>
                    <h2>traits as a transition pattern</h2>
                    <section>
                        <p>have you ever refactored 20 kLOC adam classes?</p>
                    </section>
                    <section>
                        <h3>the idea</h3>
                        <p>split adam class into multiple traits</p>
                        <p>resolve inheritance by using the traits inside the child classes</p>
                        <p>eliminate traits one by one</p>
                    </section>
                </section>
                <section>
                    <h2>conclusion</h2>
                    <p>traits can be useful if used carefully</p>
                    <p>traits can mess up your code as well as abstract classes do</p>
                    <p>don't forget everything you learned about good design</p>
                </section>
                <section>
                    <h2>thank you</h2>
                    <p>spam me:<br/><a href="mailto:me@derrabus.de">me@derrabus.de</a></p>
                    <p>follow me:<br/><a href="https://twitter.com/derrabus">@derrabus</a></p>
                    <p>hire me:<br/><a href="http://derrabus.de">http://derrabus.de</a></p>
                    <p>the slides:<br><a href="http://talks.derrabus.de/ipc12-traits">http://talks.derrabus.de/ipc12-traits</a></p>
                </section>
			</div>

			<!-- The navigational controls UI -->
			<aside class="controls">
				<a class="left" href="#">&#x25C4;</a>
				<a class="right" href="#">&#x25BA;</a>
				<a class="up" href="#">&#x25B2;</a>
				<a class="down" href="#">&#x25BC;</a>
			</aside>

			<!-- Presentation progress bar -->
			<div class="progress"><span></span></div>
			
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>
			
			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				
				theme: Reveal.getQueryHash().theme || 'derrabus', // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/linear(2d)

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/highlight.js', async: true, callback: function() { window.hljs.initHighlightingOnLoad(); } },
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'lib/js/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'lib/js/data-markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: '/socket.io/socket.io.js', async: true, condition: function() { return window.location.host === 'localhost:1947'; } },
					{ src: 'plugin/speakernotes/client.js', async: true, condition: function() { return window.location.host === 'localhost:1947'; } },
				]
			});
			
		</script>

	</body>
</html>
